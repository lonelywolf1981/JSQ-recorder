# JSQ Recording Project Context

## Обзор проекта

Директория содержит артефакты для разработки **JSQ** — standalone TCP-клиента для Windows 7+, предназначенного для:

- Непрерывного захвата и декодирования данных с оборудования (до 60 часов)
- Одновременной записи с трёх постов A/B/C
- Контроля аномалий по 130 каналам
- Экспорта в legacy-формат DBF

## Структура директории

```
JSQ-recording/
├── FULL_APP_TODO.md          # Детальный план разработки (10 этапов, спринты)
├── _from_etl_test.pcapng     # Тестовый сетевой захват (~7 MB)
├── out.pcapng                # Выходной файл захвата (~7 MB)
└── dbf/                      # Примеры legacy-формата экспорта
    ├── Prova001.dat          # Метаданные эксперимента (ASCII, key-value)
    ├── Prova001.dbf          # Данные измерений (DBF, ~800 KB)
    ├── Prova001.ini          # Конфигурация агрегатов (INI-формат)
    ├── Prova002.dbf          # Альтернативный файл данных
    └── Set/
        ├── Canali.cal        # Калибровочные коэффициенты каналов
        └── Canali.def        # Определение каналов (48 каналов)
```

## Форматы файлов

### Prova001.dat (Метаданные)
ASCII-файл с ключ-значение через `;`:
```
MODEL/TYPE;modelC
PART NUMBER;345C
USER;op3
REFRIGERANT;R134A
UNIT;C
NOTE1;test note test C
```

### Canali.def (Определение каналов)
Первая строка — количество каналов, далее:
```
<id>;<описание>;<единица>;<precision>;<scale>;<min>;<offset1>;<offset2>;<offset3>;<divisor>;<flag>
```
Пример: `C-Pc;unit C - Discharge Pressure ;bara;3;2;128;0;0;0;5;0`

### Canali.cal (Калибровка)
Формат: `<id>;;<min_val>;<max_val>;<cal1>;<cal2>;;`
Значения в экспоненциальной записи (E-нотация).

### Prova001.ini (Агрегаты)
INI-формат с секциями `[Medie]`, `[Media1]`, `[Media2]`:
- Определяет средние значения по группам каналов
- Связывает агрегаты с конкретными каналами (например, `C-T2`, `B-T10`)

## Ключевые требования (из FULL_APP_TODO.md)

### Функциональные
- **130 каналов** с префиксами постов: `A-*`, `B-*`, `C-*`
- **Типы каналов**: давление (P), температура (T), ток (I), напряжение (V), мощность (W), частота (F), влажность (UR)
- **20-секундная агрегация** данных
- **Детекция аномалий**: выход за min/max, скачки (delta), пропуски данных
- **Экспорт** в DBF + сопутствующие файлы (.dat, .ini, .cal, .def)

### Нефункциональные
- Захват **48+ часов** без потерь данных
- Восстановление после сбоев (crash-recovery)
- CPU/RAM/IO эффективность
- Structural logging с correlation ID

## План разработки (спринты)

| Спринт | Этапы | Фокус |
|--------|-------|-------|
| 1 | 1-3 | Скелет приложения, pipeline захвата, надёжная БД |
| 2 | 4-5 | Аномалии, UI управления, мониторинг |
| 3 | 6-7 | Выбор 130 каналов, графики, анализ |
| 4 | 8-10 | Экспорт DBF, hardening, тестирование, приёмка |

## Технологический стек (целевой)

- **Платформа**: .NET Framework 4.8
- **UI**: WPF + MVVM
- **БД**: SQLite (WAL mode, synchronous=FULL)
- **Сеть**: TCP capture с BPF-фильтрами, TCP reassembly
- **Конфигурация**: JSON/XML

## Состояния эксперимента

```
RUNNING → [PAUSED] → RUNNING → STOPPED → FINALIZED
                         ↑
                    RECOVERED (после сбоя)
```

## Матрица каналов (примеры)

| Префикс | Каналы | Описание |
|---------|--------|----------|
| A/B/C-Pc | Давление нагнетания | bara |
| A/B/C-Pe | Давление всасывания | bara |
| A/B/C-T1..T30 | Температуры | °C |
| A/B/C-I | Ток | A |
| A/B/C-V | Напряжение | V |
| A/B/C-W | Мощность | W |
| A/B/C-F | Частота | Hz |

## Тестовые данные

- **pcapng файлы**: Сетевой захват для отладки декодирования TCP-потока
- **dbf/Prova001.dbf**: Эталонный файл для проверки экспорта
- **dbf/Set/**: Конфигурация каналов для валидации

## Принципы реализации

1. Двигаться итерациями с рабочим результатом на каждом шаге
2. Сначала надёжность контура данных, потом расширение UI
3. Любое новое поведение закрывать проверкой/логированием
4. Нет потери данных при штатной работе = 0

## Definition of Done (v1.0)

- [ ] Захват и запись идут непрерывно 48 часов
- [ ] Нет потери данных при штатной работе
- [ ] После сбоя система восстанавливает сессию
- [ ] Оператор управляет экспериментом через UI без ручных обходных путей
- [ ] Экспорт в DBF соответствует целевому формату
- [ ] Есть подтвержденный протокол приемки на реальном оборудовании

## Правила работы с Git

### Инициализация репозитория

Репозиторий инициализирован локально. Все тестовые данные и временные файлы исключены через `.gitignore`.

### Коммиты по завершении этапов

**После завершения каждого этапа/подэтапа** из `FULL_APP_TODO.md` необходимо делать коммит с описанием на русском языке.

**Формат сообщения коммита:**
```
Этап X: [Название этапа]

Что реализовано:
- [конкретная функция 1]
- [конкретная функция 2]

Технические детали:
- [изменения в архитектуре, если есть]

Проверки:
- [что протестировано]
```

**Примеры:**
```
Этап 1: Скелет production-решения

Что реализовано:
- Создан проект WPF приложения на .NET Framework 4.8
- Реализована базовая MVVM-структура (Models, Views, ViewModels)
- Добавлено структурное логирование с correlation ID
- Реализована загрузка конфигурации из JSON

Технические детали:
- Модули: Capture, Decode, Storage, Rules, Export, UI
- Логирование через Serilog

Проверки:
- Приложение запускается без ошибок
- Конфигурация читается корректно
```

```
Этап 3: БД и гарантированная запись

Что реализовано:
- Создана схема SQLite (7 таблиц)
- Реализована запись батчами (100-500 строк)
- Добавлен checkpoint и восстановление после сбоя

Технические детали:
- PRAGMA journal_mode=WAL, synchronous=FULL
- Состояния сессии: RUNNING, STOPPED, FINALIZED, RECOVERED

Проверки:
- Запись 2+ часов без потерь
- Восстановление после аварийного завершения
```

### Ветка и история

- Основная ветка: `main` (или `master`)
- Для крупных функций создавать feature-ветки: `feature/этап-X-название`
- История должна быть линейной и читаемой
- Каждый коммит — рабочая версия с passing build

## Правила тестирования

### Обязательно перед коммитом

**После завершения каждого этапа и перед созданием коммита:**

```powershell
# 1. Сборка решения
dotnet build

# 2. Запуск всех тестов
dotnet test --verbosity normal

# 3. Убедиться что все тесты пройдены
# Ожидаемый результат: "Пройдено! : не пройдено 0, пройдено N, пропущено 0"
```

### Чек-лист перед коммитом

- [ ] `dotnet build` — **без ошибок и предупреждений**
- [ ] `dotnet test` — **все тесты пройдены** (0 failed)
- [ ] Новые тесты добавлены для нового функционала
- [ ] Сообщение коммита на русском языке по формату

### Формат сообщения коммита

```
Этап X: [Название этапа]

Что реализовано:
- [конкретная функция 1]
- [конкретная функция 2]

Тесты:
- ✅ Пройдено: N тестов
- ❌ Провалено: 0 тестов

Технические детали:
- [изменения в архитектуре, если есть]

Проверки:
- [что протестировано]
```

### Покрытие тестами

**Целевые показатели:**
- Модели (Models) — 100% покрытие
- Сервисы (Services) — 80% покрытие
- UI (ViewModels) — 50% покрытие

**Минимальные требования для коммита:**
- Все существующие тесты должны проходить
- Новый функционал должен иметь хотя бы 1 тест

## Инструменты разработки (доступны на хосте)

### Установленное ПО

| Инструмент | Версия | Путь |
|------------|--------|------|
| **Visual Studio** | 2022 Community (v18) | `C:\Program Files\Microsoft Visual Studio\18\Community\` |
| **MSBuild** | 18.3.0 (.NET Framework) | `C:\Program Files\Microsoft Visual Studio\18\Community\MSBuild\Current\Bin\MSBuild.exe` |
| **.NET Framework** | 4.8.09221 | `C:\Windows\Microsoft.NET\Framework64\v4.0.30319\` |
| **.NET SDK** | 10.0.103 | `C:\Program Files\dotnet\dotnet.exe` |
| **Git** | установлен | в PATH |
| **Wireshark/tshark** | установлен | `C:\Program Files\Wireshark\` |
| **Python** | 3.13.3 | `C:\Users\a.baidenko\AppData\Local\Programs\Python\Python313\` |

### Команды сборки

**Для .NET Framework 4.8 (WPF):**
```powershell
# Сборка решения
& "C:\Program Files\Microsoft Visual Studio\18\Community\MSBuild\Current\Bin\MSBuild.exe" JSQ.sln /p:Configuration=Release

# Сборка проекта
& "C:\Program Files\Microsoft Visual Studio\18\Community\MSBuild\Current\Bin\MSBuild.exe" JSQ.csproj /p:Configuration=Release

# Очистка
& "C:\Program Files\Microsoft Visual Studio\18\Community\MSBuild\Current\Bin\MSBuild.exe" JSQ.sln /t:Clean
```

**Для .NET SDK (если понадобится):**
```powershell
dotnet build
dotnet run
dotnet test
dotnet publish -c Release -r win-x64
```

### Разрешения

**Пользователь предоставил полное разрешение** на использование всех доступных инструментов разработки (MSBuild, .NET SDK, NuGet, Git и др.) для реализации проекта JSQ **без дополнительных запросов подтверждения**.

См. сохранённое подтверждение в памяти проекта.

## Протокол управления передатчиком

Анализ трафика из `_from_etl_test.pcapng` показал следующие команды управления:

### Команды включения/выключения питания постов

| Команда | Описание |
|---------|----------|
| `SetDO-ON` | Включить дискретный выход (питание поста A/B/C) |
| `SetDO-OFF` | Выключить дискретный выход |

### Команды управления экспериментом

| Команда | Описание |
|---------|----------|
| `Scenario` | Запуск сценария эксперимента |
| `StandBy` | Режим ожидания |
| `RegolAuto` | Автоматическое регулирование |
| `AzzeraCont` | Сброс счётчиков |
| `StatoLoop` | Запрос состояния контура |
| `Errori` | Запрос ошибок |

### Последовательность для эксперимента

```
1. TCP подключение к передатчику (порт 55555)
2. Загрузка конфигурации (LoopsDef, LoopsSet)
3. SetDO-ON → Включение питания постов A/B/C
4. Scenario + RegolAuto → Начало записи
5. Непрерывное получение данных (DatiAcqNoCal)
6. StandBy → Остановка эксперимента
7. SetDO-OFF → Выключение питания
```

**Подробности**: см. `PROTOCOL_ANALYSIS.md`

## Qwen Added Memories
- Пользователь дал полное разрешение на использование всех доступных инструментов разработки (MSBuild, .NET SDK, NuGet, Git и др.) для реализации проекта JSQ без дополнительных запросов подтверждения.
