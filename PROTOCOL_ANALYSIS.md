# Анализ протокола управления (из pcapng трафика)

## Источник данных
Файл: `_from_etl_test.pcapng` (7.3 MB)
TCP поток: порт 55555 → 62370 (192.168.0.214 → 192.168.0.216)

## Выявленные команды управления

### 1. Управление питанием постов (Digital Output)

| Команда | Hex | Описание |
|---------|-----|----------|
| `SetDO-ON` | 536574444f2d4f4e | Включить дискретный выход (питание поста) |
| `SetDO-OFF` | 536574444f2d4f4646 | Выключить дискретный выход |

**Использование:**
- Включение/выключение питания для постов A, B, C
- Отправляется перед началом эксперимента
- Отправляется после завершения эксперимента

### 2. Управление экспериментом

| Команда | Hex | Описание |
|---------|-----|----------|
| `Scenario` | 5363656e6172696f | Сценарий эксперимента |
| `StandBy` | 5374616e644279 | Режим ожидания |
| `RegolAuto` | 5265676f6c4175746f | Автоматическое регулирование |
| `Mevolute` | 4d65766f6c757465 | Эволюция/развитие (режим?) |
| `Mcollaudo` | 4d636f6c6c6175646f | Коллаудирование (режим?) |

### 3. Сброс и калибровка

| Команда | Hex | Описание |
|---------|-----|----------|
| `AzzeraCont` | 417a7a657261436f6e74 | Сброс счётчиков (итал. "azzera" = обнулить) |
| `AzzeraTunnel` | 417a7a65726154756e6e656c | Сброс тоннеля/канала |
| `DatiAcqNoCal` | 446174694163714e6f43616c | Данные АЦП без калибровки |

### 4. Мониторинг состояния

| Команда | Hex | Описание |
|---------|-----|----------|
| `StatoLoop` | 537461746f4c6f6f70 | Состояние контура регулирования |
| `DigIn` | 446967496e | Цифровые входы |
| `DigOut` | 4469674f7574 | Цифровые выходы |
| `Errori` | 4572726f7269 | Ошибки (итал.) |

### 5. Конфигурация контуров

| Команда | Hex | Описание |
|---------|-----|----------|
| `LoopsDef` | 4c6f6f7073446566 | Определение контуров |
| `LoopsSet` | 4c6f6f7073536574 | Настройка контуров |
| `LoopsParam` | 4c6f6f7073506172616d | Параметры контуров |
| `InputLoops` | 496e7075744c6f6f7073 | Входные контуры |

## Структура пакета управления

На основе анализа трафика, пакеты имеют следующую структуру:

```
[Header: 4 байта] [Command: переменная] [Payload: переменная] [Checksum?]
```

Пример для SetDO-ON:
```
53 65 74 44 4f 2d 4f 4e = "SetDO-ON"
```

## Последовательность команд для эксперимента

```
1. Подключение к передатчику (TCP handshake)
2. Загрузка конфигурации (LoopsDef, LoopsSet)
3. Включение питания постов (SetDO-ON для A/B/C)
4. Запуск эксперимента (Scenario + RegolAuto)
5. Получение данных (DatiAcqNoCal - непрерывный поток)
6. Мониторинг состояния (StatoLoop, Errori)
7. Остановка эксперимента (StandBy)
8. Выключение питания (SetDO-OFF)
9. Отключение (TCP close)
```

## Примечания

1. **Язык протокола**: Итальянский (производитель оборудования - итальянская компания)
2. **Кодировка**: ASCII
3. **Транспорт**: TCP порт 55555
4. **Формат данных**: Бинарный с ASCII командами

## Сигналы для реализации в приложении

Для управления передатчиком приложение должно отправлять:

### Включение питания поста
```csharp
// Для каждого поста (A, B, C)
SendCommand("SetDO-ON", postIndex);
```

### Выключение питания поста
```csharp
SendCommand("SetDO-OFF", postIndex);
```

### Начало записи эксперимента
```csharp
SendCommand("Scenario", experimentId);
SendCommand("RegolAuto"); // Автоматическое регулирование
```

### Окончание записи эксперимента
```csharp
SendCommand("StandBy");
SendCommand("SetDO-OFF", allPosts);
```

### Получение состояния
```csharp
// Запрос состояния контуров
SendCommand("StatoLoop");
// Запрос ошибок
SendCommand("Errori");
```

## Требуется дополнительное исследование

- Точный бинарный формат пакетов (длины, checksum)
- Mapping постов A/B/C к индексам дискретных выходов
- Формат параметров для Scenario/LoopsSet
- Таймауты и retry логика
