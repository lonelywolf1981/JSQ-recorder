# TODO: Пошаговая реализация полноценного приложения JSQ

## Цель
Собрать production-standalone-приложение под Windows 7+ в виде TCP клиента для непрерывного захвата, декодирования, контроля аномалий, надежной записи экспериментов (до 60 часов) одновременно с трех постов A/B/C/
для каждого поста можно задать свой набор датчиков из общего количества за исключением уже занятых на других постах и экспорта в legacy-формат DBF.

## Принципы реализации
- Двигаться итерациями с рабочим результатом на каждом шаге.
- Сначала надежность контура данных, потом расширение UI.
- Любое новое поведение закрывать проверкой/логированием.

## Этап 0. Формализация требований и freeze формата (1 неделя)
- [ ] Зафиксировать канонический список 130 каналов: `id`, `name`, `unit`, `index`.
- [ ] По извлеченным из фалйлов зхвата данным реализовать передачу из приложения сигналов на включение и отключение устройств на передатчике.
- [ ] Зафиксировать правила аномалий (по каждому каналу): `min`, `max`, `anomaly_type`.
- [ ] Зафиксировать контракт записи в БД и экспорт в `Prova001.dbf`.
- [ ] Зафиксировать модель эксперимента: старт/пауза/возобновление/стоп.
- [ ] Зафиксировать не-функциональные требования: CPU/RAM/допустимые потери.

Результат:
- Подписанный `spec` (Markdown/Confluence) + тестовые кейсы приемки.

## Этап 1. Скелет production-решения (1 неделя)
- [ ] Создать основной проект приложения (C# .NET Framework 4.8, WPF, MVVM).
- [ ] Разделить на модули:
  - `Capture`,
  - `Decode`,
  - `Storage`,
  - `Rules`,
  - `Export`,
  - `UI`.
- [ ] Подключить структурное логирование и единый correlation id сессии.
- [ ] Настроить базовую конфигурацию (json/xml) и проверку при старте.

Результат:
- Приложение стартует, позоляет задать настройки передатчика (адрес и порт) и протестировать соединение, пишет системный лог, показывает главный экран.

## Этап 2. Надежный контур захвата и декодирования (2 недели)
- [ ] Реализовать выбор интерфейса захвата (индекс/имя), фильтр BPF.
- [ ] Реализовать pipeline:
  - `ingest queue` -> `decode queue` -> `persist queue`.
- [ ] Реализовать устойчивый TCP reassembly:
  - обработка retransmit,
  - обработка gap (флаги качества, без падения процесса).
- [ ] Реализовать мониторинг pipeline:
  - длина очередей,
  - throughput,
  - drops/errors.

Критерии:
- Захват 2+ часа без аварий.
- Нет зависаний при росте нагрузки.
- Логи содержат метрики и причины ошибок.

## Этап 3. БД и гарантированная запись (2 недели)
- [ ] Ввести SQLite-схему:
  - `experiments`,
  - `operators`,
  - `channel_config`,
  - `raw_samples`,
  - `agg_samples_20s`,
  - `anomaly_events`,
  - `system_events`.
- [ ] Включить режимы:
  - `PRAGMA journal_mode=WAL`,
  - `PRAGMA synchronous=FULL`.
- [ ] Реализовать запись батчами (100-500 строк или 1 сек timeout).
- [ ] Реализовать checkpoint + восстановление после сбоя.
- [ ] Реализовать состояние сессии:
  - `RUNNING`,
  - `STOPPED`,
  - `FINALIZED`,
  - `RECOVERED`.

Критерии:
- После аварийного завершения приложение восстанавливает незавершенный эксперимент.
- Потери данных при штатной работе = 0.

## Этап 4. Агрегация и движок правил аномалий (1-2 недели)
- [ ] Реализовать 20-секундную агрегацию с корректной временной сеткой.
- [ ] Реализовать обработку `-99` и quality flags.
- [ ] Реализовать правила:
  - выход за min/max,
  - скачок (delta),
  - пропуск данных (no-data timeout).
- [ ] Реализовать подавление дребезга (hysteresis/debounce).
- [ ] Логировать аномалии как события с контекстом.

Критерии:
- На тестовом наборе аномалии детектируются детерминированно.
- Нет флуктуаций WARN/ALARM из-за шума.

## Этап 5. UI v1: управление и обзор состояния (2 недели)
- [ ] Экран создания/запуска эксперимента.
- [ ] Экран управления: Start/Pause/Resume/Stop.
- [ ] Глобальная панель здоровья:
  - `OK/WARN/ALARM/NO-DATA`,
  - очередь, dropped, latency commit.
- [ ] Матрица каналов 130 шт. с цветовой индикацией.
- [ ] Реалтайм-лог событий.

Критерии:
- Оператор за 1 взгляд видит: "все ок" или "где проблема".
- Реакция UI в realtime без зависаний.

## Этап 6. UI v2: удобный выбор 130 каналов (1 неделя)
- [ ] Выбор каналов через:
  - группы (A/B/C, Pressure, Temperature, Electrical, System),
  - поиск,
  - multi-select таблицу,
  - массовые операции.
- [ ] Пресеты выбора каналов:
  - сохранить/загрузить профиль.
- [ ] Массовая настройка лимитов для выделения.

Критерии:
- Настройка 130 каналов занимает минуты, а не ручной обход чекбоксов.

## Этап 7. Графики и анализ по каналу (1 неделя)
- [ ] График по выбранному каналу:
  - raw + aggregated,
  - лимиты,
  - точки аномалий.
- [ ] Time range: 5m / 30m / 2h / all.
- [ ] Быстрый переход из события в график.

Критерии:
- Любую аномалию можно объяснить по графику за 2-3 клика.

## Этап 8. Экспорт и защита от перезаписи (1 неделя)
- [ ] Экспорт из БД в legacy-пакет:
  - `Prova001.dbf`,
  - `Set\Canali.def`,
  - `Set\Canali.cal`,
  - `Prova001.dat`,
  - `Prova001.ini`.
- [ ] Атомарный экспорт во временную папку + rename.
- [ ] Политика имён/версий сессий (исключить overwrite).
- [ ] Блокировка изменения завершенных сессий.

Критерии:
- Экспорт проходит стабильно, структура файлов соответствует эталону.

## Этап 9. Эксплуатационная готовность (1-2 недели)
- [ ] Режим автозапуска/службы.
- [ ] Recovery policy при падении.
- [ ] Архивация и ротация логов/данных.
- [ ] Диагностический пакет (logs + config + metrics snapshot).

Критерии:
- Прогон 48 часов без критических сбоев.
- Recovery проверен на реальных сценариях.

## Этап 10. Тестирование и приемка (2 недели)
- [ ] Unit tests:
  - декодирование,
  - агрегация,
  - правила аномалий.
- [ ] Integration tests:
  - pipeline end-to-end,
  - crash-recovery,
  - export DBF.
- [ ] Performance tests:
  - CPU/RAM/IO на 48-часовом сценарии.
- [ ] UAT с оператором на реальном стенде.

Критерии:
- Протокол приемки закрыт по всем пунктам.
- Выпуск `v1.0` разрешен.

---

## Приоритеты реализации (если делать по спринтам)

### Sprint 1 (ядро)
- Этапы 1-3 (скелет, pipeline, надежная БД-запись).

### Sprint 2 (контроль)
- Этап 4-5 (аномалии, обзорный UI, управление экспериментом).

### Sprint 3 (удобство)
- Этапы 6-7 (выбор 130 каналов, графики, быстрый анализ).

### Sprint 4 (выпуск)
- Этапы 8-10 (экспорт, hardening, 48h test, приемка).

---

## Definition of Done для полноценного приложения
- Захват и запись идут непрерывно 48 часов.
- Нет потери данных при штатной работе.
- После сбоя система восстанавливает сессию.
- Оператор управляет экспериментом через UI без ручных обходных путей.
- Экспорт в DBF соответствует целевому формату.
- Есть подтвержденный протокол приемки на реальном оборудовании.
